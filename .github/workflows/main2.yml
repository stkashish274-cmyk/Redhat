name: Tailscale SSH (No Root, 2025 Stable)

on:
  workflow_dispatch:

jobs:
  tailscale:
    runs-on: self-hosted  # or ubuntu-latest if using GitHub-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq (if not already available)
        run: |
          if ! command -v jq >/dev/null; then
            echo "Installing jq locally..."
            mkdir -p $HOME/bin
            curl -fsSL https://github.com/stedolan/jq/releases/latest/download/jq-linux64 -o $HOME/bin/jq
            chmod +x $HOME/bin/jq
            export PATH="$HOME/bin:$PATH"
          fi

      - name: Install Tailscale (no sudo, no root)
        run: |
          mkdir -p $HOME/tailscale
          cd $HOME/tailscale
          
          # ✅ Use jq to safely parse GitHub JSON API
          URL=$(curl -fsSL https://api.github.com/repos/tailscale/tailscale/releases/latest \
            | jq -r '.assets[] | select(.name | test("amd64\\.tgz$")) | .browser_download_url')

          echo "Downloading: $URL"
          curl -fsSL "$URL" -o tailscale.tgz
          tar xzf tailscale.tgz
          echo "✅ Tailscale extracted to $HOME/tailscale"

      - name: Start Tailscale (userspace, no root)
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          cd $HOME/tailscale
          ./tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          sleep 3
          ./tailscale up --authkey=${TS_AUTHKEY} --ssh --hostname=gh-runner
          ./tailscale status

      - name: Show Tailscale IP
        run: |
          cd $HOME/tailscale
          ./tailscale ip -4
