name: Tailscale SSH (No Root, Working 2025)

on:
  workflow_dispatch:

jobs:
  tailscale:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tailscale (no sudo)
        run: |
          mkdir -p $HOME/tailscale
          cd $HOME/tailscale
          # ✅ Get latest release tarball URL for amd64 Linux
          URL=$(curl -fsSL https://api.github.com/repos/tailscale/tailscale/releases/latest \
            | grep "browser_download_url" \
            | grep "amd64.tgz" \
            | cut -d '"' -f 4)
          echo "Downloading: $URL"
          curl -fsSL "$URL" -o tailscale.tgz
          tar xzf tailscale.tgz
          echo "✅ Tailscale extracted to $HOME/tailscale"

      - name: Start Tailscale (userspace, no root)
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          cd $HOME/tailscale
          ./tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          sleep 3
          ./tailscale up --authkey=${TS_AUTHKEY} --ssh --hostname=gh-runner
          ./tailscale status

      - name: Show Tailscale IP
        run: |
          cd $HOME/tailscale
          ./tailscale ip -4
