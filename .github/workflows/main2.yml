name: Tailscale SSH (No Root, Working)

on:
  workflow_dispatch:

jobs:
  tailscale:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tailscale (no sudo)
        run: |
          mkdir -p $HOME/tailscale
          cd $HOME/tailscale
          # Download latest Linux AMD64 build from GitHub releases
          curl -fsSL https://api.github.com/repos/tailscale/tailscale/releases/latest \
            | grep "browser_download_url.*linux_amd64.tgz" \
            | cut -d '"' -f 4 \
            | xargs curl -fsSL -o tailscale.tgz
          tar xzf tailscale.tgz
          echo "âœ… Tailscale extracted to $HOME/tailscale"

      - name: Start Tailscale (userspace)
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          cd $HOME/tailscale
          ./tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          sleep 3
          ./tailscale up --authkey=${TS_AUTHKEY} --ssh --hostname=gh-runner
          ./tailscale status

      - name: Show Tailscale IP
        run: |
          cd $HOME/tailscale
          ./tailscale ip -4
