name: Always Run Tailscale SSH

on:
  workflow_dispatch:   # manual start
  push:                # or start on code push
  watch:
    types: [started]   # keep running

jobs:
  tailscale-ssh:
    runs-on: self-hosted

    steps:
      - name: Install Tailscale (no sudo)
        run: |
          mkdir -p $HOME/bin
          cd $HOME/bin
          echo "⬇️ Downloading Tailscale..."
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale_1.68.1_amd64.tgz -o tailscale.tgz
          tar xzf tailscale.tgz --strip-components=1
          chmod +x tailscale
          ./tailscale version

      - name: Start Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          export PATH=$HOME/bin:$PATH
          ./tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          sleep 5
          ./tailscale up --authkey=${TAILSCALE_AUTH_KEY} --hostname=github-runner --ssh

      - name: Show Tailscale status
        run: |
          export PATH=$HOME/bin:$PATH
          ./tailscale status
          echo "Tailscale IP:"
          ./tailscale ip -4
