name: üü¢ Always Run Tailscale (No sudo)

on:
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: self-hosted
    timeout-minutes: 999999

    steps:
      - name: üì¶ Install Tailscale (no sudo)
        run: |
          mkdir -p $HOME/bin
          cd $HOME/bin

          echo "‚¨áÔ∏è Downloading Tailscale..."
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale_amd64.tgz -o tailscale.tgz

          echo "üì¶ Extracting..."
          tar -xzf tailscale.tgz --strip-components=1
          rm tailscale.tgz
          chmod +x tailscale*

          echo "‚úÖ Installed Tailscale version:"
          ./tailscale version

      - name: üîê Connect to Tailscale
        env:
          TS_AUTH_KEY: ${{ secrets.TS_AUTH_KEY }}
        run: |
          export PATH=$HOME/bin:$PATH

          echo "üöÄ Starting tailscaled..."
          nohup tailscaled \
            --state=$HOME/tailscaled.state \
            --socket=$HOME/tailscale.sock \
            --port=41641 > $HOME/tailscaled.log 2>&1 &

          sleep 5

          echo "üîë Logging in to Tailscale..."
          tailscale up \
            --socket=$HOME/tailscale.sock \
            --authkey=${TS_AUTH_KEY} \
            --ssh \
            --accept-dns=false || true

          echo "‚úÖ Connection info:"
          tailscale ip --socket=$HOME/tailscale.sock || true

      - name: üîÑ Keep Tailscale alive forever
        run: |
          export PATH=$HOME/bin:$PATH
          echo "üïí Starting Tailscale monitor loop..."
          while true; do
            echo "---------------------------------------"
            echo "‚è∞ $(date)"
            if tailscale status --socket=$HOME/tailscale.sock >/dev/null 2>&1; then
              echo "‚úÖ Tailscale OK: $(tailscale ip --socket=$HOME/tailscale.sock | head -n 1)"
            else
              echo "‚ö†Ô∏è Tailscale offline ‚Äî restarting..."
              nohup tailscaled \
                --state=$HOME/tailscaled.state \
                --socket=$HOME/tailscale.sock \
                --port=41641 > $HOME/tailscaled.log 2>&1 &
              sleep 5
              tailscale up \
                --socket=$HOME/tailscale.sock \
                --authkey=${TS_AUTH_KEY} \
                --ssh \
                --accept-dns=false || echo "‚ö†Ô∏è Reconnect failed"
            fi
            sleep 300  # check every 5 minutes
          done
