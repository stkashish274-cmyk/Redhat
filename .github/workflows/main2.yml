name: Tailscale SSH (No Root)

on:
  workflow_dispatch:

jobs:
  connect-tailscale:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tailscale locally (no sudo)
        run: |
          mkdir -p $HOME/tailscale
          cd $HOME/tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale_amd64.tgz -o tailscale.tgz
          tar xzf tailscale.tgz
          echo "✅ Tailscale binaries extracted to $HOME/tailscale"

      - name: Start Tailscale (userspace mode)
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          cd $HOME/tailscale
          ./tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          sleep 3
          ./tailscale up --authkey=${TS_AUTHKEY} --ssh --hostname=gh-runner
          ./tailscale status

      - name: Confirm IP & SSH readiness
        run: |
          cd $HOME/tailscale
          ./tailscale ip -4
          echo "✅ Tailscale SSH active (userspace, no sudo)"
