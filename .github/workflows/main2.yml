name: Tailscale Always Run (Self-hosted)

on:
  workflow_dispatch:  # Manual start
  push:
  watch:
    types: [started]

jobs:
  tailscale:
    runs-on: self-hosted

    steps:
      - name: Prepare environment
        run: |
          mkdir -p $HOME/bin
          cd $HOME/bin
          echo "⬇️ Downloading Tailscale..."
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale_1.68.1_amd64.tgz -o tailscale.tgz
          tar -xzf tailscale.tgz
          ls -R tailscale_1.68.1_amd64 || true
          mv tailscale_1.68.1_amd64/* .
          chmod +x tailscale tailscaled
          echo "✅ Tailscale installed at $HOME/bin"
          ./tailscale version

      - name: Start Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          export PATH=$HOME/bin:$PATH
          echo "🚀 Starting Tailscaled in user mode..."
          nohup $HOME/bin/tailscaled --tun=userspace-networking --socks5-server=localhost:1055 > $HOME/tailscaled.log 2>&1 &
          sleep 8
          echo "🔐 Logging into Tailscale..."
          $HOME/bin/tailscale up --authkey=${TAILSCALE_AUTH_KEY} --hostname=github-runner --ssh
          echo "✅ Connected to Tailscale!"

      - name: Show Tailscale IP
        run: |
          export PATH=$HOME/bin:$PATH
          echo "📡 Current Tailscale IP:"
          $HOME/bin/tailscale ip -4
          echo "🌐 Status:"
          $HOME/bin/tailscale status
