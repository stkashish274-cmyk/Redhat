name: 🟢 Always Run — Tailscale Connection

on:
  workflow_dispatch:
  push:
  workflow_run:
  workflow_call:

jobs:
  tailscale-always:
    runs-on: self-hosted
    timeout-minutes: 0  # disable job timeout (infinite)

    steps:
      - name: 📦 Install and start Tailscale (no sudo)
        run: |
          mkdir -p $HOME/bin
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale_1.70.0_amd64.tgz -o ts.tgz
          tar -xzf ts.tgz
          mv tailscale_*_amd64/tailscale $HOME/bin/
          mv tailscale_*_amd64/tailscaled $HOME/bin/
          export PATH=$HOME/bin:$PATH

          echo "🚀 Starting tailscaled..."
          nohup $HOME/bin/tailscaled --state=$HOME/tailscale.state --socket=$HOME/tailscale.sock > tailscaled.log 2>&1 &
          sleep 5

          echo "🔑 Logging into Tailscale..."
          $HOME/bin/tailscale --socket=$HOME/tailscale.sock up \
            --authkey=${{ secrets.TAILSCALE_AUTHKEY }} \
            --ssh --hostname=selfhosted-runner

      - name: 🌐 Show and monitor IP forever
        run: |
          export PATH=$HOME/bin:$PATH
          echo "✅ Connected to Tailscale! Starting infinite loop..."
          while true; do
            IP4=$($HOME/bin/tailscale --socket=$HOME/tailscale.sock ip -4 | head -n1)
            IP6=$($HOME/bin/tailscale --socket=$HOME/tailscale.sock ip -6 | head -n1)
            echo "🕒 $(date) | IPv4: $IP4 | IPv6: $IP6"
            sleep 300  # check every 5 minutes
          done
