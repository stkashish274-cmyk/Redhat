name: Tailscale (normal script, no sudo)
on:
  workflow_dispatch:

jobs:
  tailscale:
    runs-on: self-hosted  # or ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Tailscale with normal script (no sudo)
        run: |
          mkdir -p $HOME/tailscale
          cd $HOME/tailscale
          # Just fetch and unpack — skip system install
          curl -fsSL https://tailscale.com/install.sh -o install.sh
          bash install.sh --dry-run | grep "https://pkgs" | grep ".tgz" | head -n1 | xargs curl -fsSL -o tailscale.tgz
          tar xzf tailscale.tgz
          echo "✅ Tailscale extracted to $HOME/tailscale"

      - name: Start Tailscale (userspace)
        env:
          TS_AUTHKEY: ${{ secrets.TS_AUTHKEY }}
        run: |
          cd $HOME/tailscale
          ./tailscaled --tun=userspace-networking --socks5-server=localhost:1055 &
          sleep 3
          ./tailscale up --authkey=${TS_AUTHKEY} --ssh --hostname=gh-runner
          ./tailscale status

      - name: Show IP
        run: |
          cd $HOME/tailscale
          ./tailscale ip -4
