name: 24/7 OpenShift VM Auto-Restart (No sudo)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"  # every 15 mins fallback check

jobs:
  monitor-vm:
    runs-on: self-hosted
    timeout-minutes: 0

    steps:
      - name: Install OpenShift CLI and virtctl (no sudo)
        run: |
          mkdir -p ~/bin && cd ~/bin

          echo "üì¶ Installing oc CLI..."
          curl -L -o oc.tar.gz https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xzf oc.tar.gz >/dev/null 2>&1 || true
          chmod +x oc kubectl 2>/dev/null || true

          echo "üì¶ Installing virtctl..."
          curl -L -o virtctl https://github.com/kubevirt/kubevirt/releases/download/v1.5.2/virtctl-v1.5.2-linux-amd64
          chmod +x virtctl

          echo "‚úÖ CLI tools ready."
          export PATH=$HOME/bin:$PATH

      - name: Login to OpenShift
        env:
          OPENSHIFT_API_URL: ${{ secrets.OPENSHIFT_API_URL }}
          OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
        run: |
          export PATH=$HOME/bin:$PATH
          ~/bin/oc login --token="$OPENSHIFT_TOKEN" --server="$OPENSHIFT_API_URL" --insecure-skip-tls-verify
          ~/bin/oc project stkcyber-dev

      - name: Continuous VM monitor loop
        run: |
          export PATH=$HOME/bin:$PATH
          VM_NAME="centos-stream9-tan-flea-48"
          NS="stkcyber-dev"

          echo "üü¢ VM Monitor started ‚Äî running forever..."
          while true; do
            STATUS=$(~/bin/oc get vm "$VM_NAME" -n "$NS" -o jsonpath='{.status.printableStatus}' 2>/dev/null || echo "Unknown")
            TIME=$(date '+%Y-%m-%d %H:%M:%S')
            echo "[$TIME] Current VM status: $STATUS"

            if [ "$STATUS" = "Running" ]; then
              echo "‚úÖ VM healthy."
            else
              echo "‚ö†Ô∏è VM stopped or crashed ‚Äî restarting..."
              ~/bin/virtctl start "$VM_NAME" -n "$NS" || echo "‚ùå Restart failed"
              sleep 60
            fi

            echo "üí§ Sleeping for 5 minutes..."
            sleep 300
          done
