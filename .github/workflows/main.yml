name: Auto-Start OpenShift VM (every 5 minutes)

on:
  schedule:
    - cron: "*/5 * * * *"  # Run every 5 minutes
  workflow_dispatch:

jobs:
  keep-vm-running:
    runs-on: ubuntu-latest

    steps:
      - name: Install OpenShift CLI and virtctl (no sudo)
        run: |
          mkdir -p ~/bin && cd ~/bin

          echo "ğŸ“¦ Installing OpenShift CLI (GLIBC compatible)..."
          curl -L -o oc.tar.gz https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.7.0/openshift-client-linux.tar.gz
          tar -xzf oc.tar.gz >/dev/null 2>&1 || true
          chmod +x oc kubectl 2>/dev/null || true

          echo "ğŸ“¦ Installing virtctl..."
          curl -L -o virtctl https://github.com/kubevirt/kubevirt/releases/download/v0.48.0/virtctl-v0.48.0-linux-amd64
          chmod +x virtctl

          echo "âœ… CLI tools ready."
          export PATH=$HOME/bin:$PATH
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Login to OpenShift
        env:
          OPENSHIFT_API_URL: ${{ secrets.OPENSHIFT_API_URL }}
          OPENSHIFT_TOKEN: ${{ secrets.OPENSHIFT_TOKEN }}
        run: |
          export PATH=$HOME/bin:$PATH
          echo "ğŸ” Logging in to OpenShift..."
          ./oc login --token="$OPENSHIFT_TOKEN" --server="$OPENSHIFT_API_URL" --insecure-skip-tls-verify
          ./oc project stkcyber-dev

      - name: Check and ensure VM is running
        run: |
          export PATH=$HOME/bin:$PATH
          VM_NAME="centos-stream9-tan-flea-48"
          NS="stkcyber-dev"

          echo "ğŸ” Checking VM status..."
          STATUS=$(./oc get vm $VM_NAME -n $NS -o jsonpath='{.status.printableStatus}' 2>/dev/null || echo "Unknown")
          echo "ğŸ“¡ Current VM status: $STATUS"

          if [ "$STATUS" = "Running" ]; then
            echo "âœ… VM is already running."
          else
            echo "âš ï¸ VM is not running. Attempting restart..."
            ./virtctl start "$VM_NAME" -n "$NS" || echo "âš ï¸ Failed to start VM."
            sleep 30
            STATUS2=$(./oc get vm $VM_NAME -n $NS -o jsonpath='{.status.printableStatus}' 2>/dev/null || echo "Unknown")
            echo "ğŸ“¡ New status: $STATUS2"
            if [ "$STATUS2" = "Running" ]; then
              echo "âœ… VM restarted successfully!"
            else
              echo "âŒ VM did not start properly â€” check OpenShift console."
              exit 1
            fi
          fi
